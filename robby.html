<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script type="text/javascript" src="lib/jquery.min.js"></script>
  <script type="text/javascript" src="lib/osql.js"></script>
  <style>
    .center {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
  </style>
  <script>
    osql.requireLogin();
    var title = decodeURIComponent(osql.getParam('title'));
    var username = decodeURIComponent(osql.getParam('Username'));
    var me;

    $(document).ready(async function () {
      me = await osql.getMe();
      document.getElementById('firstname').innerHTML = me.fname;
      document.getElementById('lastname').innerHTML = me.lname;

      refreshTitles(); // 初回のタイトル一覧の表示

      setInterval(refreshTitles, 2000); // 2秒ごとにタイトル一覧を更新
      loadPastTitles(); // 過去の物語一覧の表示
    });

    async function buttonPressed() {
      var roomName = document.getElementById('tf').value;
      if (roomName.trim() === "") {
        alert("ルーム名を入力してください");
        return;
      }
      createRoom(roomName);
    }

    async function createRoom(roomName) {
      var sql = `INSERT INTO Titles (title) VALUES ('${roomName}');`;
      try {
        await osql.connectInsert(sql);
        alert("ルーム名がデータベースに挿入されました");
        refreshTitles();
      } catch (error) {
        console.log(error);
        alert("ルーム名の挿入中にエラーが発生しました");
      }
    }

    async function refreshTitles() {
      var sql = 'SELECT * FROM Titles;';
      try {
        var titles = await osql.connect(sql);
        var html = '<ul>';
        for (var i = 0; i < titles.length; i++) {
          var title = titles[i];
          html += '<li>' + title.title + '</li>';
        }
        html += '</ul>';
        document.getElementById('titleList').innerHTML = html;
      } catch (error) {
        console.log(error);
        alert("タイトルの取得中にエラーが発生しました");
      }
    }

    async function button7Pressed() {
      var title = document.getElementById('tf7').value;
      if (title.trim() === "") {
        alert("タイトルが選択されていません");
        return;
      }
      var found = false;
      var titles = document.querySelectorAll("#titleList li");
      for (var i = 0; i < titles.length; i++) {
        if (titles[i].innerText === title) {
          found = true;
          break;
        }
      }
      if (found) {
        var roomId = await getRoomIdByTitle(title);
        var username = decodeURIComponent(osql.getParam('Username'));
        if (roomId !== null) {
          window.location.href = `room.html?username=${username}&title=${encodeURIComponent(title)}`;
          return;
        }
      }
      alert("存在しないタイトルです");
    }

    async function getRoomIdByTitle(title) {
      var sql = `SELECT * FROM Titles WHERE title = '${title}';`;
      try {
        var result = await osql.connect(sql);
        if (result.length > 0) {
          return result[0].id;
        }
      } catch (error) {
        console.log(error);
      }
      return null;
    }

    function loadPastTitles() {
      var sql = 'SELECT * FROM past;';
      try {
        osql.connect(sql).then(function (result) {
          var html = '<ul>';
          for (var i = 0; i < result.length; i++) {
            var pastTitle = result[i].title;
            html += '<li><a href="past.html?title=' + encodeURIComponent(pastTitle) + '&Username=' + encodeURIComponent(username) + '">' + pastTitle + '</a></li>';
          }
          html += '</ul>';
          document.getElementById('pastTitleList').innerHTML = html;
        }).catch(function (error) {
          console.log(error);
          alert("過去の物語一覧の取得中にエラーが発生しました");
        });
      } catch (error) {
        console.log(error);
        alert("過去の物語一覧の取得中にエラーが発生しました");
      }
    }
  </script>
</head>

<body>
  <h1>ルーム選択</h1>
  <hr>
  <div style="text-align: right;">
    ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
    <a href="index.html">top</a>
  </div>
  <div style="text-align: center;">
    <h2>ルームを作成する</h2>
    ルーム名:<input id="tf" type="text">
    <button onclick="buttonPressed()">決定</button>
    <br>
    <hr>
    <h3>ルームを選択</h3>
    選択したいタイトル:<input id="tf7" type="text">
    <button onclick="button7Pressed()">決定</button>
    <hr>
    <div class="center">
      <h3>タイトル一覧</h3>
      <div id="titleList"></div>
    </div>
    <hr>
    <div class="center">
      <h3>過去の物語一覧</h3>
      <div id="pastTitleList"></div>
    </div>
  </div>
</body>

</html>